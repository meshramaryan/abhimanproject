<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CarServ — Unified Site + Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ---------- BASE THEME ---------- */
    :root{
      --accent:#D81324;
      --bg-dark: linear-gradient(120deg,#071534 0%, #0f2a3b 60%, #0b1724 100%);
      --glass: rgba(255,255,255,0.04);
      --panel: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --muted: rgba(255,255,255,0.85);
      --muted-2: rgba(255,255,255,0.65);
    }
    body{ margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg-dark); color:var(--muted); -webkit-font-smoothing:antialiased; min-height:100vh; }
    a { text-decoration:none; color:inherit; }

    /* ---------- LAYOUT ---------- */
    .container-full { width:100%; max-width:1200px; margin: 30px auto; padding: 0 18px; }

    /* ---------- TOP NAV (public) ---------- */
    .site-top {
      background: rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.03);
      padding:10px 0;
    }
    .site-top .brand { color:var(--muted); font-weight:700; display:flex;align-items:center; gap:10px; }
    .site-top .brand i{ color:var(--accent); font-size:22px; }

    /* ---------- PAGE AREAS ---------- */
    .view { display:none; padding:18px 0 60px; }
    .view.active { display:block; }

    /* ---------- HOME / POST STYLES ---------- */
    .hero {
      background-image: url('img/carousel-bg-1.jpg');
      background-size:cover; background-position:center;
      border-radius:12px; padding:60px 20px; color:#fff; margin-bottom:18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    .post-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; margin-bottom:12px; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
    .post-card h5 { color:#fff; margin-bottom:6px; }
    .post-image { width:220px; height:140px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,0.03); }

    /* ---------- LOGIN BOX ---------- */
    .login-wrap{ display:flex; align-items:center; justify-content:center; min-height:80vh; }
    .login-box { width:380px; background:#fff; color:#111; padding:30px; border-radius:12px; box-shadow:0 14px 40px rgba(2,6,23,0.6); }
    .login-box h2 { color:var(--accent); margin-bottom:16px; font-weight:800; }

    /* ---------- ADMIN DASHBOARD ---------- */
    .app { display:grid; grid-template-columns: 260px 1fr; gap:18px; padding:20px; min-height:70vh; }
    .sidebar {
      background:var(--panel); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      color:var(--muted-2);
      height: calc(100vh - 60px); position:sticky; top:30px; overflow:auto;
    }
    .logo { width:44px;height:44px;border-radius:8px;background:linear-gradient(45deg,var(--accent), #ff6b6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700; }
    .nav-item{ display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted-2); }
    .nav-item i{ color:var(--accent); width:24px; text-align:center; }
    .nav-item.active{ background: rgba(255,255,255,0.02); color:#fff; }

    .main { padding:6px 8px; overflow:auto; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
    .search { background:var(--glass); padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); display:flex; align-items:center; gap:8px; }
    .icon-btn{ background:var(--panel); padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03); cursor:pointer; color:var(--muted-2); }

    .panel { background:var(--panel); padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03); color:var(--muted); margin-bottom:12px; }
    .cards { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .card-mini { padding:12px; border-radius:8px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:var(--muted); }

    /* modal + toast */
    #modalRoot{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,0.6); }
    .modal { position:relative; width:760px; max-width:95%; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); z-index:2; color:var(--muted); }

    .toast { position:fixed; right:20px; bottom:20px; background:var(--accent); color:white; padding:10px 14px; border-radius:8px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index:99999; }

    /* responsive */
    @media(max-width:1000px){
      .app{ grid-template-columns: 80px 1fr; }
      .nav-item span{ display:none; }
      .cards{ grid-template-columns: repeat(1,1fr); }
      .post-image{ width:100%; height:180px; }
    }
  </style>
</head>
<body>

  <!-- ===== PUBLIC SITE TOP BAR ===== -->
  <header class="site-top">
    <div class="container-full d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="brand"><i class="bi bi-fire"></i> Abhiman Automobiles</div>
        <nav class="d-none d-md-flex gap-3">
          <a href="#" class="nav-link link-light" data-nav="home">Home</a>
          <a href="#" class="nav-link link-light" data-nav="services">Services</a>
          <a href="#" class="nav-link link-light" data-nav="about">About</a>
          <a href="#" class="nav-link link-light" data-nav="team">Team</a>
          <a href="#" class="nav-link link-light" data-nav="booking">Booking</a>
          <a href="#" class="nav-link link-light" data-nav="contact">Contact</a>
        </nav>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-light" id="openLoginBtn">Admin Login</button>
        <a href="#" class="btn btn-sm btn-primary d-none d-md-inline" id="openDashboardPublic">Admin Dashboard</a>
      </div>
    </div>
  </header>

  <!-- ===== MAIN SINGLE-PAGE VIEWS ===== -->
  <main class="container-full">

    <!-- LOGIN VIEW (will show when user clicks admin or not logged in) -->
    <div id="view-login" class="view">
      <div class="login-wrap">
        <div class="login-box">
          <h2><i class="bi bi-tools"></i> QualityServ Admin</h2>
          <input id="loginUsername" class="form-control mb-2" placeholder="Username">
          <input id="loginPassword" class="form-control mb-3" placeholder="Password" type="password">
          <button class="btn btn-primary w-100 mb-2" id="loginBtn">Login</button>
          <div class="text-danger small" id="loginError" style="display:none">Invalid username or password</div>
          <div class="mt-3 small text-muted">Use <strong>admin</strong> / <strong>12345</strong> (demo)</div>
        </div>
      </div>
    </div>

    <!-- PUBLIC HOME VIEW -->
    <div id="view-home" class="view active">
      <div class="hero">
        <h1 class="display-5">Abhiman Automobiles & Engineering Works</h1>
        <p class="lead">We deliver expert vehicle repairs and maintenance with care and precision. Our skilled team uses modern tools and genuine parts to ensure every service is reliable and efficient.</p>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <h3 class="mb-3">Latest Posts</h3>
          <div id="publicPosts"></div>
        </div>
        <div class="col-lg-4">
          <div class="panel">
            <h5>Services</h5>
            <ul class="list-unstyled small">
              <li>Quality Servicing</li>
              <li>Expert Workers</li>
              <li>Modern Equipment</li>
              <li>Oil Changing</li>
            </ul>
          </div>

          <div class="panel mt-3">
            <h5>Gallery</h5>
            <div id="publicGallery" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SERVICES -->
    <div id="view-services" class="view">
      <h2>Services</h2>
      <p>We offer full vehicle servicing, specialist repairs, fleet maintenance and more — content retained from your original files.</p>
      <!-- (compact) -->
    </div>

    <!-- ABOUT -->
    <div id="view-about" class="view">
      <h2>About</h2>
      <p>Abhiman Automobiles & Engineering Works — Experience, quality and trust.</p>
    </div>

    <!-- TEAM -->
    <div id="view-team" class="view">
      <h2>Team</h2>
      <p>Our skilled technicians and staff.</p>
    </div>

    <!-- BOOKING -->
    <div id="view-booking" class="view">
      <h2>Booking</h2>
      <p>Booking form placeholder (use your booking.html content here if you want).</p>
    </div>

    <!-- CONTACT -->
    <div id="view-contact" class="view">
      <h2>Contact</h2>
      <p>Contact details & form (retain your contact.html content).</p>
    </div>

    <!-- 404 -->
    <div id="view-404" class="view">
      <h2>404 — Page not found</h2>
    </div>

    <!-- ===== ADMIN DASHBOARD VIEW (hidden unless logged in) ===== -->
    <div id="view-admin" class="view" style="padding:0;">
      <div class="app">

        <!-- SIDEBAR -->
        <aside class="sidebar" id="adminSidebar">
          <div>
            <div class="d-flex align-items-center gap-12 mb-3">
              <div class="logo">CS</div>
              <div>
                <div style="font-weight:700;color:#fff">CarServ Pro</div>
                <div style="font-size:12px;color:var(--muted-2)">Admin Panel</div>
              </div>
            </div>

            <div id="adminNav">
              <div class="nav-item active" data-panel="panel-dashboard"><i class="bi bi-speedometer2"></i><span> Dashboard</span></div>
              <div class="nav-item" data-panel="panel-users"><i class="bi bi-people"></i><span> Users</span></div>
              <div class="nav-item" data-panel="panel-posts"><i class="bi bi-card-image"></i><span> Posts</span></div>
              <div class="nav-item" data-panel="panel-gallery"><i class="bi bi-images"></i><span> Gallery</span></div>
              <div class="nav-item" data-panel="panel-comments"><i class="bi bi-chat-dots"></i><span> Comments</span></div>
              <div class="nav-item" data-panel="panel-messages"><i class="bi bi-envelope"></i><span> Messages</span></div>
              <div class="nav-item" data-panel="panel-settings"><i class="bi bi-gear"></i><span> Settings</span></div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:12px; color:var(--muted-2)">
            <div>v1.0</div>
            <div>© CarServ</div>
          </div>
        </aside>

        <!-- MAIN -->
        <section class="main">
          <div class="topbar">
            <div class="search">
              <i class="bi bi-search" style="color:var(--accent)"></i>
              <input id="adminSearch" placeholder="Search users, posts, comments..." style="background:transparent;border:0;outline:none;color:var(--muted);width:260px" />
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="icon-btn" id="notifBtn"><i class="bi bi-bell"></i></div>
              <div class="icon-btn" id="collapseBtn"><i class="bi bi-chevron-left"></i></div>

              <div class="d-flex align-items-center gap-2" id="profileBox">
                <div id="profileInitial" style="width:36px;height:36px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">A</div>
                <div style="line-height:1">
                  <div id="profileName" style="font-weight:700;color:#fff">Admin</div>
                  <div id="profileEmail" style="font-size:12px;color:var(--muted-2)">admin@carserv.com</div>
                </div>
                <button class="btn btn-sm btn-outline-light" id="logoutBtn">Logout</button>
              </div>
            </div>
          </div>

          <!-- PANELS -->
          <div id="panel-dashboard" class="panel card">
            <h4 style="color:#fff">Dashboard</h4>
            <div class="cards">
              <div class="card-mini">
                <h3 id="statUsers">0</h3>
                <p>Users</p>
              </div>
              <div class="card-mini">
                <h3 id="statPosts">0</h3>
                <p>Posts</p>
              </div>
              <div class="card-mini">
                <h3 id="statComments">0</h3>
                <p>Comments</p>
              </div>
            </div>

            <div style="margin-top:12px" class="panel">
              <h5 style="color:#fff">Quick Actions</h5>
              <div class="d-flex gap-2">
                <button class="btn" onclick="openCreatePost()">+ New Post</button>
                <button class="btn" onclick="openAddUser()">+ Add User</button>
              </div>
            </div>

            <canvas id="dashboardChart" style="margin-top:12px; height:220px;"></canvas>
          </div>

          <!-- USERS -->
          <div id="panel-users" class="panel" style="display:none;">
            <h4 style="color:#fff">Users</h4>
            <button class="btn ghost mb-2" onclick="openAddUser()">+ Add User</button>
            <table class="table" id="usersTable" style="width:100%;color:var(--muted)">
              <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- POSTS -->
          <div id="panel-posts" class="panel" style="display:none;">
            <h4 style="color:#fff">Posts</h4>
            <div id="postsContainer"></div>
          </div>

          <!-- GALLERY -->
          <div id="panel-gallery" class="panel" style="display:none;">
            <h4 style="color:#fff">Gallery</h4>
            <div class="gallery" id="galleryGrid" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            <div style="margin-top:10px">
              <input type="file" id="galleryUpload" accept="image/*" multiple>
            </div>
          </div>

          <!-- COMMENTS -->
          <div id="panel-comments" class="panel" style="display:none;">
            <h4 style="color:#fff">Comments</h4>
            <div id="commentsContainer"></div>
            <div style="margin-top:12px">
              <input id="newCommentName" placeholder="Your name" style="padding:8px;width:40%;margin-right:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
              <input id="newCommentText" placeholder="Your comment" style="padding:8px;width:50%;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
              <button class="btn" onclick="addCommentFromPanel()">Add Comment</button>
            </div>
          </div>

          <!-- MESSAGES -->
          <div id="panel-messages" class="panel" style="display:none;">
            <h4 style="color:#fff">Messages</h4>
            <div id="messagesContainer"></div>
            <div style="margin-top:12px">
              <input id="msgFrom" placeholder="From" style="padding:8px;width:30%;margin-right:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
              <input id="msgText" placeholder="Message" style="padding:8px;width:50%;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
              <button class="btn" onclick="sendMessage()">Send</button>
            </div>
          </div>

          <!-- SETTINGS -->
          <div id="panel-settings" class="panel" style="display:none;">
            <h4 style="color:#fff">Settings</h4>
            <label><strong>Theme</strong></label>
            <div class="d-flex gap-2 mt-2">
              <button class="btn ghost" onclick="applyTheme('red')">Red</button>
              <button class="btn ghost" onclick="applyTheme('blue')">Blue</button>
              <button class="btn ghost" onclick="applyTheme('green')">Green</button>
              <button class="btn ghost" onclick="applyTheme('purple')">Purple</button>
              <button class="btn ghost" onclick="applyTheme('light')">Light</button>
            </div>
            <hr>
            <label><strong>Upload Profile</strong></label>
            <input type="file" id="profileUpload" accept="image/*" class="mt-2">
          </div>

        </section>
      </div>
    </div>

  </main>

  <!-- MODAL + TOAST ROOT -->
  <div id="modalRoot"></div>
  <div id="toastRoot"></div>

  <!-- ===== SCRIPTS: Single-file SPA Logic ===== -->
  <script>
    /*************** STORAGE KEY & DEFAULT STATE ***************/
    const STORAGE_KEY = 'carserv_master_v1';
    const defaultState = {
      users: [{id:1,name:'Admin User',email:'admin@carserv.com',role:'admin'}],
      posts: [],
      comments: [],
      gallery: [],
      messages: [],
      notifications: [],
      settings: { theme: 'red', optNotifications:true, optComments:true, optShowGallery:true},
      profile: { name:'Admin', email:'admin@carserv.com', avatar: null }
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState)); return JSON.parse(JSON.stringify(defaultState)); }
        return JSON.parse(raw);
      } catch(e){ console.error(e); return JSON.parse(JSON.stringify(defaultState)); }
    }
    function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // app state
    let state = loadState();

    /*************** NAVIGATION (SPA) ***************/
    const views = {
      login: document.getElementById('view-login'),
      home: document.getElementById('view-home'),
      services: document.getElementById('view-services'),
      about: document.getElementById('view-about'),
      team: document.getElementById('view-team'),
      booking: document.getElementById('view-booking'),
      contact: document.getElementById('view-contact'),
      admin: document.getElementById('view-admin'),
      '404': document.getElementById('view-404')
    };

    function showView(name){
      Object.values(views).forEach(v=>v.classList.remove('active'));
      if(views[name]){ views[name].classList.add('active'); window.scrollTo({top:0, behavior:'smooth'}); }
      else { views['404'].classList.add('active'); }
    }

    // header nav clicks
    document.querySelectorAll('[data-nav]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault(); const nav = a.getAttribute('data-nav');
        if(nav === 'home') showView('home');
        else if(nav === 'services') showView('services');
        else if(nav === 'about') showView('about');
        else if(nav === 'team') showView('team');
        else if(nav === 'booking') showView('booking');
        else if(nav === 'contact') showView('contact');
      });
    });

    // open login
    document.getElementById('openLoginBtn').addEventListener('click', ()=> showView('login'));
    document.getElementById('openDashboardPublic').addEventListener('click', ()=>{
      if(isLoggedIn()) showView('admin'); else showView('login');
    });

    /*************** AUTH (login/logout) ***************/
    function isLoggedIn(){ return localStorage.getItem('loggedIn') === 'true'; }
    // login button
    document.getElementById('loginBtn').addEventListener('click', ()=>{
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value.trim();
      // demo credentials
      if(u === 'admin' && p === '12345'){
        localStorage.setItem('loggedIn','true');
        // ensure state saved
        saveState(state);
        showNotification('Logged in as admin');
        setTimeout(()=> { showView('admin'); initApp(); }, 400);
      } else {
        const e = document.getElementById('loginError'); e.style.display='block';
        setTimeout(()=> e.style.display='none', 2500);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      if(confirm('Logout?')){
        localStorage.setItem('loggedIn','false');
        showNotification('Logged out');
        showView('home');
      }
    });

    // Protect admin view on page load
    if(isLoggedIn()){
      // if admin was logged in and user navigates to site, allow them to open admin
      document.getElementById('openDashboardPublic').classList.remove('d-none');
    } else {
      document.getElementById('openDashboardPublic').classList.add('d-none');
    }

    /*************** MODAL & TOAST HELPERS ***************/
    function showModal(html){
      const root = document.getElementById('modalRoot');
      root.innerHTML = '<div class="modal-backdrop"></div><div class="modal">'+html+'</div>';
      root.style.display = 'flex';
      root.querySelector('.modal-backdrop').addEventListener('click', closeModal);
    }
    function closeModal(){ const root = document.getElementById('modalRoot'); root.innerHTML=''; root.style.display='none'; }

    function toast(msg, time=1600){
      const t = document.createElement('div'); t.className='toast'; t.textContent = msg;
      document.getElementById('toastRoot').appendChild(t);
      setTimeout(()=> t.style.opacity='0.01', time);
      setTimeout(()=> t.remove(), time+300);
    }

    function showNotification(msg){
      toast(msg, 2000);
    }

    /*************** RENDER FUNCTIONS ***************/
    function renderPublicPosts(){
      const wrap = document.getElementById('publicPosts'); wrap.innerHTML='';
      if(!state.posts || state.posts.length===0){ wrap.innerHTML = '<p style="color:rgba(255,255,255,0.6)">No posts yet.</p>'; return; }
      state.posts.slice().reverse().forEach(p=>{
        const outer = document.createElement('div'); outer.className='post-card d-flex gap-3 align-items-start';
        outer.innerHTML = `
          ${p.image ? `<img class="post-image" src="${p.image}" alt="">` : `<div style="width:220px;height:140px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--muted-2)">No Image</div>`}
          <div style="flex:1">
            <h5>${escapeHtml(p.title)}</h5>
            <p style="margin:0;color:var(--muted-2)">${escapeHtml(p.body)}</p>
          </div>
        `;
        wrap.appendChild(outer);
      });
    }
    function renderGallery(){
      const g = document.getElementById('galleryGrid'); g.innerHTML='';
      const pg = document.getElementById('publicGallery'); pg.innerHTML='';
      if(!state.gallery || state.gallery.length===0){
        g.innerHTML = '<div style="color:var(--muted-2)">No gallery</div>';
      } else {
        state.gallery.slice().reverse().forEach(src=>{
          const img = document.createElement('img'); img.src = src; img.style.width='100px'; img.style.height='70px'; img.style.objectFit='cover'; img.style.borderRadius='6px'; img.style.border='1px solid rgba(255,255,255,0.03)'; img.style.cursor='pointer';
          img.addEventListener('click', ()=> showModal(`<img src="${src}" style="max-width:100%;border-radius:8px" />`));
          g.appendChild(img);
          const img2 = img.cloneNode(); pg.appendChild(img2);
        });
      }
    }
    function renderUsers(){
      const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML='';
      (state.users||[]).forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.role)}</td>
          <td><button class="btn ghost" onclick="openEditUser(${u.id})">Edit</button> <button class="btn ghost" onclick="deleteUser(${u.id})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function renderPosts(){
      const wrap = document.getElementById('postsContainer'); wrap.innerHTML='';
      if(!state.posts || state.posts.length===0) wrap.innerHTML = '<p style="color:var(--muted-2)">No posts yet. Create one from New Post.</p>';
      state.posts.slice().reverse().forEach(p=>{
        const div = document.createElement('div'); div.className='panel'; div.style.marginBottom='10px';
        div.innerHTML = `<div style="display:flex;gap:12px">
            ${p.image? `<img src="${p.image}" style="width:140px;height:90px;object-fit:cover;border-radius:8px">` : `<div style="width:140px;height:90px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--muted-2)">No Image</div>`}
            <div style="flex:1">
              <h5 style="margin:0;color:#fff">${escapeHtml(p.title)}</h5>
              <p style="color:var(--muted-2);margin:6px 0">${escapeHtml(p.body)}</p>
              <div style="display:flex;gap:8px">
                <button class="btn ghost" onclick="openEditPost(${p.id})">Edit</button>
                <button class="btn ghost" onclick="deletePost(${p.id})">Delete</button>
              </div>
            </div>
          </div>`;
        wrap.appendChild(div);
      });
    }
    function renderComments(){
      const wrap = document.getElementById('commentsContainer'); wrap.innerHTML='';
      if(!state.comments || state.comments.length===0) wrap.innerHTML = '<p style="color:var(--muted-2)">No comments</p>';
      state.comments.slice().reverse().forEach((c, idx)=>{
        const d = document.createElement('div'); d.style.marginBottom='8px';
        d.innerHTML = `<strong style="color:#fff">${escapeHtml(c.name)}</strong><div style="color:var(--muted-2)">${escapeHtml(c.text)}</div>
          <div style="margin-top:6px"><button class="btn ghost" onclick="deleteComment(${idx})">Delete</button></div>`;
        wrap.appendChild(d);
      });

      // sidebar preview
      const sc = document.getElementById('sidebarComments'); if(sc){ sc.innerHTML=''; (state.comments||[]).slice().reverse().slice(0,3).forEach(c=>{ const p=document.createElement('p'); p.style.margin='6px 0'; p.style.color='var(--muted-2)'; p.innerHTML = `<strong style="color:#fff">${escapeHtml(c.name)}</strong>: ${escapeHtml(c.text)}`; sc.appendChild(p); }); }
    }
    function renderMessages(){
      const wrap = document.getElementById('messagesContainer'); wrap.innerHTML='';
      if(!state.messages || state.messages.length===0) wrap.innerHTML = '<p style="color:var(--muted-2)">No messages</p>';
      (state.messages||[]).slice().reverse().forEach(m=>{
        const d = document.createElement('div'); d.style.marginBottom='8px';
        d.innerHTML = `<strong style="color:#fff">${escapeHtml(m.from)}</strong><div style="color:var(--muted-2)">${escapeHtml(m.text)}</div>`;
        wrap.appendChild(d);
      });
    }

    function renderCounts(){
      document.getElementById('statUsers').textContent = state.users ? state.users.length : 0;
      document.getElementById('statPosts').textContent = state.posts ? state.posts.length : 0;
      document.getElementById('statComments').textContent = state.comments ? state.comments.length : 0;
      document.getElementById('profileName').textContent = state.profile.name || 'Admin';
      document.getElementById('profileEmail').textContent = state.profile.email || 'admin@carserv.com';
      // show/hide admin button in public header
      if(isLoggedIn()) document.getElementById('openDashboardPublic').classList.remove('d-none'); else document.getElementById('openDashboardPublic').classList.add('d-none');
    }

    /*************** CRUD & ACTIONS ***************/
    // Users
    window.openAddUser = function(){
      showModal(`<h3>Add User</h3>
        <div style="display:grid;gap:8px;margin-top:8px">
          <input id="newName" placeholder="Name" class="form-control"/>
          <input id="newEmail" placeholder="Email" class="form-control"/>
          <select id="newRole" class="form-select"><option>user</option><option>admin</option></select>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" onclick="closeModal()">Cancel</button>
            <button class="btn" onclick="createUser()">Create</button>
          </div>
        </div>`);
    };
    window.createUser = function(){
      const name = document.getElementById('newName').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const role = document.getElementById('newRole').value;
      if(!name || !email){ alert('Enter name and email'); return; }
      const id = Date.now();
      state.users.push({id,name,email,role});
      saveState(state); closeModal(); renderUsers(); renderCounts(); showNotification('User added');
    };
    window.openEditUser = function(id){
      const u = state.users.find(x=>x.id===id); if(!u) return;
      showModal(`<h3>Edit User</h3>
        <div style="display:grid;gap:8px;margin-top:8px">
          <input id="editName" value="${escapeHtml(u.name)}" class="form-control"/>
          <input id="editEmail" value="${escapeHtml(u.email)}" class="form-control"/>
          <select id="editRole" class="form-select"><option ${u.role==='user'?'selected':''}>user</option><option ${u.role==='admin'?'selected':''}>admin</option></select>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" onclick="closeModal()">Cancel</button>
            <button class="btn" onclick="saveUser(${u.id})">Save</button>
          </div>
        </div>`);
    };
    window.saveUser = function(id){
      const u = state.users.find(x=>x.id===id);
      u.name = document.getElementById('editName').value.trim();
      u.email = document.getElementById('editEmail').value.trim();
      u.role = document.getElementById('editRole').value;
      saveState(state); closeModal(); renderUsers(); showNotification('User updated');
    };
    window.deleteUser = function(id){
      if(!confirm('Delete user?')) return;
      state.users = state.users.filter(u=>u.id!==id);
      saveState(state); renderUsers(); renderCounts(); showNotification('User deleted');
    };

    // Posts
    window.openCreatePost = function(){
      showModal(`<h3>Create Post</h3>
        <div style="display:grid;gap:8px;margin-top:8px">
          <input id="postTitle" placeholder="Title" class="form-control"/>
          <textarea id="postBody" placeholder="Write something..." rows="4" class="form-control"></textarea>
          <label>Image (optional)</label><input type="file" id="postImage" accept="image/*" class="form-control">
          <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn ghost" onclick="closeModal()">Cancel</button><button class="btn" onclick="createPost()">Publish</button></div>
        </div>`);
    };
    window.createPost = function(){
      const title = document.getElementById('postTitle').value.trim();
      const body = document.getElementById('postBody').value.trim();
      if(!title){ alert('Title required'); return; }
      const file = document.getElementById('postImage').files[0];
      const id = Date.now();
      if(file){ const reader = new FileReader(); reader.onload = function(e){
        const src = e.target.result;
        state.posts.push({id,title,body,image:src});
        state.gallery.push(src);
        saveState(state); closeModal(); renderPosts(); renderGallery(); renderPublicPosts(); renderCounts(); showNotification('Post created with image');
      }; reader.readAsDataURL(file); } else {
        state.posts.push({id,title,body,image:null});
        saveState(state); closeModal(); renderPosts(); renderPublicPosts(); renderCounts(); showNotification('Post created');
      }
    };
    window.openEditPost = function(id){
      const p = state.posts.find(x=>x.id===id); if(!p) return;
      showModal(`<h3>Edit Post</h3>
        <div style="display:grid;gap:8px;margin-top:8px">
          <input id="editPostTitle" value="${escapeHtml(p.title)}" class="form-control"/>
          <textarea id="editPostBody" rows="4" class="form-control">${escapeHtml(p.body)}</textarea>
          <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn ghost" onclick="closeModal()">Cancel</button><button class="btn" onclick="savePost(${p.id})">Save</button></div>
        </div>`);
    };
    window.savePost = function(id){
      const p = state.posts.find(x=>x.id===id);
      p.title = document.getElementById('editPostTitle').value.trim();
      p.body = document.getElementById('editPostBody').value.trim();
      saveState(state); closeModal(); renderPosts(); renderPublicPosts(); showNotification('Post updated');
    };
    window.deletePost = function(id){
      if(!confirm('Delete post?')) return;
      state.posts = state.posts.filter(p=>p.id!==id);
      saveState(state); renderPosts(); renderGallery(); renderPublicPosts(); renderCounts(); showNotification('Post deleted');
    };

    // Comments
    window.addCommentFromPanel = function(){
      const n = document.getElementById('newCommentName').value.trim()||'Anonymous';
      const t = document.getElementById('newCommentText').value.trim();
      if(!t) { alert('Type comment'); return; }
      state.comments.push({name:n, text:t});
      saveState(state); renderComments(); renderCounts(); showNotification('Comment added');
      document.getElementById('newCommentName').value=''; document.getElementById('newCommentText').value='';
    };
    window.deleteComment = function(idx){ if(!confirm('Delete comment?')) return; state.comments.splice(idx,1); saveState(state); renderComments(); renderCounts(); showNotification('Comment removed'); };

    // Messages
    window.sendMessage = function(){
      const from = document.getElementById('msgFrom').value.trim()||'Guest';
      const text = document.getElementById('msgText').value.trim(); if(!text) return alert('Message empty');
      state.messages.push({from,text,ts:Date.now()});
      saveState(state); renderMessages(); showNotification('Message sent'); document.getElementById('msgFrom').value=''; document.getElementById('msgText').value='';
    };

    // Uploads
    document.getElementById('galleryUpload')?.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []); if(files.length===0) return;
      let added=0;
      files.forEach(f=>{
        const r=new FileReader(); r.onload=function(ev){ state.gallery.push(ev.target.result); added++; if(added===files.length){ saveState(state); renderGallery(); renderPublicPosts(); renderCounts(); showNotification(added+' images added'); } }; r.readAsDataURL(f);
      });
    });

    document.getElementById('profileUpload')?.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = function(ev){ state.profile.avatar = ev.target.result; saveState(state); showProfile(); showNotification('Profile image updated'); }
      r.readAsDataURL(f);
    });

    function applyTheme(name){
      document.body.setAttribute('data-theme', name);
      state.settings.theme = name; saveState(state); renderCounts();
      showNotification('Theme applied: ' + name);
    }

    function showProfile(){
      const img = document.getElementById('profileInitial');
      if(state.profile.avatar){ img.style.background='transparent'; img.innerHTML = `<img src="${state.profile.avatar}" style="width:36px;height:36px;border-radius:8px">`; }
      else { img.innerHTML = (state.profile.name||'A').charAt(0).toUpperCase(); img.style.background = 'var(--accent)'; }
      document.getElementById('profileName').textContent = state.profile.name || 'Admin';
      document.getElementById('profileEmail').textContent = state.profile.email || 'admin@carserv.com';
    }

    /*************** SEARCH, NAV BEHAVIOR & SIDEBAR ***************/
    document.getElementById('adminSearch')?.addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      // filter users
      document.querySelectorAll('#usersTable tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
      // filter posts
      document.querySelectorAll('#postsContainer .panel').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    document.querySelectorAll('#adminNav .nav-item').forEach(it=>{
      it.addEventListener('click', ()=> {
        document.querySelectorAll('#adminNav .nav-item').forEach(n=>n.classList.remove('active'));
        it.classList.add('active');
        const panels = ['panel-dashboard','panel-users','panel-posts','panel-gallery','panel-comments','panel-messages','panel-settings'];
        panels.forEach(id=> document.getElementById(id).style.display = 'none');
        const target = document.getElementById(it.dataset.panel);
        if(target) target.style.display = 'block';
        window.scrollTo({top:0, behavior:'smooth'});
      });
    });

    document.getElementById('collapseBtn')?.addEventListener('click', ()=>{
      document.getElementById('adminSidebar').classList.toggle('collapsed');
      const ico = document.querySelector('#collapseBtn i'); ico.classList.toggle('bi-chevron-left'); ico.classList.toggle('bi-chevron-right');
    });

    /*************** CHARTS & ANIMATIONS ***************/
    let dashboardChart;
    function initCharts(){
      const ctx = document.getElementById('dashboardChart')?.getContext('2d');
      if(!ctx) return;
      dashboardChart = new Chart(ctx, {
        type:'bar',
        data:{ labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets:[{ label:'Bookings', data:[5,8,6,12,10,9,7], backgroundColor: getComputedStyle(document.body).getPropertyValue('--accent') || '#D81324' }] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
      });
    }
    function updateCharts(){ if(!dashboardChart) return; dashboardChart.data.datasets[0].data = dashboardChart.data.datasets[0].data.map(v => Math.max(1, v + Math.round((Math.random()*6)-3))); dashboardChart.update(); }

    /*************** INIT APP ***************/
    function initApp(){
      state = loadState(); showProfile(); renderCounts(); renderUsers(); renderPosts(); renderComments(); renderGallery(); renderPublicPosts(); renderMessages(); initCharts();
      setInterval(()=> updateCharts(), 4000);
    }

    // run init
    initApp();

    /*************** UTIL HELPERS ***************/
    function escapeHtml(unsafe){
      if(!unsafe && unsafe !== 0) return '';
      return String(unsafe).replace(/[&<>"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]; });
    }

    // Safe page load: if user arrived with admin view request and not logged in -> show login
    // Example: ?admin in URL can be used to jump to admin page (but locked)
    (function handleUrlHash(){
      if(location.hash === '#admin' && !isLoggedIn()){ showView('login'); }
      if(location.hash === '#admin' && isLoggedIn()){ showView('admin'); initApp(); }
    })();

    /*************** SMALL POLISH: modal + keyboard close ***************/
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

    /*************** ESCAPE: expose some functions to window for html onclick handlers ***************/
    window.openCreatePost = openCreatePost;
    window.openAddUser = openAddUser;
    window.openEditPost = openEditPost;
    window.openEditUser = openEditUser;
    window.deletePost = deletePost;
    window.deleteUser = deleteUser;
    window.applyTheme = applyTheme;
    window.addCommentFromPanel = addCommentFromPanel;
    window.sendMessage = sendMessage;
    window.deleteComment = deleteComment;
    window.showImageModal = (src)=> showModal(`<img src="${src}" style="max-width:100%;border-radius:8px" />`);
    window.closeModal = closeModal;

    /*************** FINISH ***************/
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
